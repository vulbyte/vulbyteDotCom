<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/client_management.js" type="module"></script>
    <title>game rankings</title>

<style>
        :root {
            --icon_wh: 2em; 
        }
        
        /* --- General Layout --- */
                tr {
                    border-bottom: solid white 0.2em;
                    padding-top: 0.6em;
                    padding-bottom: 0.6em;
                }
        
        #review_table {
            width: 100%;
            max-width: 60rem;
            margin-left: auto;
            margin-right: auto;
            border-collapse: collapse; /* Cleaner table borders */
        }

        #overall {
            font-size: 3em;
        }

        /* --- COLUMN SPECIFIC STYLING (The replacement for nth-child) --- */

        /* COLUMN 1: GAME INFO (Image & Links) */
        .col-game {
            display: flex; 
            flex-direction: column; /* Stack items vertically: Image Div, then Links Div */
            align-items: center; /* Center content horizontally */
            vertical-align: top;
            padding-bottom: 1em;
                        min-width: 10em;
        }

        /* NEW: Container for the image, needs to take up all remaining vertical space */
        .col-game > div:first-child {
            flex-grow: 1; /* Consumes all available vertical space */
            display: flex;
            justify-content: center; /* Center image horizontally within this container */
            align-items: center; /* Center image vertically within this container */
            width: 100%;
            min-height: 0; /* Ensure flex item doesn't force a minimum height based on content */
        }

        /* The Game Cover Image */
        .game-cover-image {
            display: block;      
            margin: 0;           /* Handled by flex parent now */
            max-width: 100%;     
            max-height: 20rem;   
            width: auto;         
            height: auto;        
            object-fit: contain; 
            border-radius: 4px;  
        }

        /* Store Links Container */
        #store_links {
            height: 3rem;
            display: flex;
            justify-content: center; /* Centers the flex items (icons) */
            gap: 1em; /* Adds space between icons */
            margin-top: 0.5em;
        }

        /* Store Icons Styling */
        .store-icon {
            height: 3rem !important;
            width: 3rem !important;
            display: inline-block;
        }

        .store-icon.iconitch {
            filter: invert(1);
        }

        .store-icon.iconyout{
            height: calc(var(--icon_wh) * 0.70);
            width: var(--icon_wh);
        }

        /* COLUMN 2: RATINGS */
        .col-ratings {
            vertical-align: top;
            min-width: 8em; /* Ensures rating column doesn't get too squished */
                        width:10em;
        }

        /* COLUMN 3: TLDR (Text) */
                .col-tldr, .col-tldr > div {
            vertical-align: top;
                        width:20em;
                        max-height: 17em;
                        overflow-y: scroll;
        }


        /* --- GRAPH & CHART CONTAINERS --- */

        #ranking_graph_container {
            width: 100%;
            max-width: 60em;
            margin: 2rem auto;
            border: 1px solid #333;
            background-color: #050505;
            border-radius: 1em;
            position: relative;
            padding: 2rem 1rem 3rem 3rem;
            box-sizing: border-box;
        }

        .graph-watermark-image {
            position: absolute;
            width: 70%;
            height: 70%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            background-image: url('/assets/icon.svg'); 
            background-repeat: no-repeat;
            background-position: center;
            background-size: 50%;
            opacity: 0.1;
            pointer-events: none;
        }

        #ranking_graph {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            border-left: 2px solid #555;
            border-bottom: 2px solid #555;
            z-index: 5;
        }

        .graph-grid-line {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #222;
            left: 0;
            pointer-events: none;
        }

        .graph-node {
            position: absolute;
            transform: translate(-50%, 50%);
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            z-index: 10;
        }

        .graph-node:hover {
            transform: translate(-50%, 50%) scale(1.5);
            z-index: 20;
            border-color: white;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .graph-node img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .graph-node::after {
            content: attr(data-title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .graph-node:hover::after {
            opacity: 1;
        }

        .axis-label {
            position: absolute;
            color: #777;
            font-size: 0.8rem;
        }
        .y-label-top { top: 0; left: -2.5rem; }
        .y-label-mid { top: 50%; left: -2.5rem; }
        .y-label-bot { bottom: 0; left: -2.5rem; }
        .x-label-start { bottom: -1.5rem; left: 0; }
        .x-label-end { bottom: -1.5rem; right: 0; }
        
        .no-data-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #555;
        }

        #review_distribution_container {
            width: 100%;
            max-width: 60em;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #050505;
            border: 1px solid #333;
            border-radius: 1em;
            box-sizing: border-box;
            position: relative;
        }
        #review_distribution_chart {
            display: block;
            width: 100% !important; 
            height: auto !important;
        }


        /* --- MOBILE / CARD VIEW --- */

        @media screen and (max-width: 900px) {
            #review_table {
                max-width: none;
                margin: 0;
                border: none;
                background: none;
            }

            /* Hide the main header row using ID */
            #table_header_row {
                display: none;
            }

            #review_table tr {
                display: block;
                margin-bottom: 2em;
                background-color: #050505;
                border-radius: 0.5em;
                padding: 1em;
                border: 1px solid #333;
                height: auto;
            }

            /* Make ALL cells block elements */
            #review_table td {
                display: block;
                text-align: left;
                padding: 0.5em 0;
                width: 100% !important;
                box-sizing: border-box;
                border-bottom: 1px solid #222;
            }
            
            #review_table td:last-child {
                 border-bottom: none;
            }

            /* Add labels */
            #review_table td::before {
                content: attr(data-label);
                font-weight: bold;
                color: #fff;
                margin-right: 0.5em;
                display: block;
                font-size: 1em;
            }
            
            /* --- Mobile Specific Overrides using Classes --- */
            /* Adjust image max height for mobile */
            .game-cover-image {
                max-height: 15rem; 
            }
            
                        .col-ratings * {
                            justify-content:center;
              text-align: center; /* Revert this if flex is fully used, but keeping for safety */
                        }

            /* Center the game column content */
            .col-game {
                text-align: center; /* Revert this if flex is fully used, but keeping for safety */
            }
            
            .col-tldr > div {
                 max-height: 10em;
                 overflow: visible;
                                 width:auto;
            }
        }
    </style>
</head>

<body>
    <div>
        <hgroup>
            <h1>game rankings</h1>
            <h6>by vulbyte</h6>
        </hgroup>
    </div>
    <div>
        <h2>preliminary</h2>
        <p>
            hello! i'm vulbyte and this is my ranking of games!
        </p>
    </div>

    <div style="padding:1em; max-width: 60em; margin: auto;">
        <label for="sortingOption">sorting method:</label>
        <select id="sortingOption"></select>
    </div>

    <div id="ranking_graph_container">
        <div class="graph-watermark-image"></div>
        <div id="ranking_graph"></div>
        <span class="axis-label y-label-top">10.0</span>
        <span class="axis-label y-label-mid">5.0</span>
        <span class="axis-label y-label-bot">0.0</span>
        <span class="axis-label x-label-start" id="date-start">Oldest</span>
        <span class="axis-label x-label-end" id="date-end">Newest</span>
    </div>

    <div>
        <h2>Review Distribution: <span id="distribution-category">Overall</span></h2>
        <div id="review_distribution_container">
            <canvas id="review_distribution_chart" width="1920" height="1080"></canvas>
            <p class="no-data-msg" style="display:none;"></p>
        </div>
    </div>

    <div>
        <ol>
            <li>scam</li>
            <li>horrible</li>
            <li>bad</li>
            <li>unplesant</li>
            <li>eh</li>
            <li>fine</li>
            <li>good</li>
            <li>great</li>
            <li>outstanding</li>
            <li>category defining</li>
        </ol>
        
        <table id="review_table">
            <thead>
                <tr id="table_header_row">
                    <th>game</th>
                    <th>ratings</th>
                    <th>tldr</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

<script type="module">
    const icons = {
        appstore: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/67/App_Store_%28iOS%29.svg/2048px-App_Store_%28iOS%29.svg.png",
        epic: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/31/Epic_Games_logo.svg/1032px-Epic_Games_logo.svg.png?20180409155704",
        gamejolt: "https://m.gjcdn.net/fireside-post-image/600/24010743-ll-sfbhunum-v4.webp",
        gog: "https://www.gog.com/pressroom/wp-content/uploads/2025/06/GOG_LOGO_WHITE.png",
        itch: "https://static.itch.io/images/itchio-textless-black.svg",
        nintendo: `https://avatars.mds.yandex.net/get-mpic/15406152/2a0000019813155773b80c2b06a01e852603/orig`,
        playstation: "https://brandlogos.net/wp-content/uploads/2022/09/playstation_store-logo_brandlogos.net_q6kzh-512x512.png",
        playstore: "https://storage.googleapis.com/gweb-uniblog-publish-prod/images/Logo_Play_512px_clr_nGVTgYY.max-1440x810.png",
        steam: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Steam_icon_logo.svg/1024px-Steam_icon_logo.svg.png",
        website: "/assets/website_icon.svg",
        xbox: "https://www.freepnglogos.com/uploads/xbox-png/xbox-png-download-best-xbox-png-clipartmagm-15.png",
        youtube: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/1024px-YouTube_full-color_icon_%282017%29.svg.png?20240107144800"
    };
    
    import reviews from "./reviews.js";;

    function CE(args = {}) {
        let elem = document.createElement(args.elem || "div");
        if (args.innerText != undefined) elem.innerText = args.innerText;
        if (args.innerHTML != undefined) elem.innerHTML = args.innerHTML;
        // Fix for args.href was referencing def.href
        if (args.href != undefined) {
            elem.href = args.href;
            if(!args.href.startsWith('#')) elem.target = "_blank";  
        }
        if (args.alt != undefined) {elem.alt = args.alt};
        if (args.src != undefined) {elem.src = args.src};
        if (args.id != undefined) {elem.id = args.id};

        // Class handling fix (using the for loop variant as discussed)
        if (args.class) {
             const classes = String(args.class).trim().split(/\s+/).filter(c => c.length > 0);
             if (classes.length > 0) {
                 for(let i = 0; i < classes.length; ++i) {
                     elem.classList.add(classes[i]);
                 }
             }
        }
        
        if (args.title != undefined) {elem.setAttribute('data-title', args.title)};

        return elem;
    }

    /* --- GRAPH & CHART MANAGERS (Unchanged Logic) --- */
    const GraphManager = {
        container: document.getElementById('ranking_graph'),
        lblStart: document.getElementById('date-start'),
        lblEnd: document.getElementById('date-end'),
        getTime: (review, index) => {
            if (review.date) return new Date(review.date).getTime();
            return index; 
        },
        getRating: (review, category) => {
            let key = category.replace('-asc', '').replace('-desc', '');
            if (key === 'overall') {
                if (review.rankings.overall !== undefined) return review.rankings.overall;
                const rankings = Object.entries(review.rankings).filter(([k]) => k !== 'overall');
                if (rankings.length === 0) return null; 
                const sum = rankings.reduce((acc, [, val]) => acc + val, 0);
                return parseFloat((sum / rankings.length).toFixed(1));
            }
            if (review.rankings[key] !== undefined) return review.rankings[key];
            return null; 
        },
        draw: (sortMethod = 'overall-desc') => {
            const self = GraphManager;
            self.container.innerHTML = '';
            const [category, dir] = sortMethod.split('-');
            const isInverted = dir === 'asc'; 

            [2.5, 5.0, 7.5].forEach(val => {
                let line = CE({elem: 'div', class: 'graph-grid-line'});
                line.style.bottom = `${val * 10}%`;
                self.container.appendChild(line);
            });

            let validData = reviews.map((r, i) => ({
                ...r, origIndex: i, val: self.getRating(r, category), time: self.getTime(r, i)
            })).filter(item => item.val !== null);

            if (validData.length === 0) {
                self.container.appendChild(CE({elem:'div', class:'no-data-msg', innerText:`No '${category}' ratings`}));
                return;
            }

            let minTime = Math.min(...validData.map(d => d.time));
            let maxTime = Math.max(...validData.map(d => d.time));
            let timeSpan = maxTime - minTime;
            if(timeSpan === 0) timeSpan = 1; 

            if (validData[0].date) {
                self.lblStart.innerText = new Date(minTime).toLocaleDateString();
                self.lblEnd.innerText = new Date(maxTime).toLocaleDateString();
            } else {
                self.lblStart.innerText = "Last Added";
                self.lblEnd.innerText = "First Added";
            }

            validData.forEach(item => {
                let xPercent = ((item.time - minTime) / timeSpan) * 90 + 5; 
                let baseYPercent = (item.val / 10) * 100;
                let yPercent = isInverted ? (100 - baseYPercent) : baseYPercent;
                let link = CE({ elem: 'a', href: `#review_ref_${item.origIndex}`, class: 'graph-node', title: `${item.name}: ${item.val}/10` });
                link.style.left = `${xPercent}%`;
                link.style.bottom = `${yPercent}%`;
                let r8_color = "#" + Math.floor((((item.val - 11) * -1) / 10) * 255).toString(16) + Math.floor(item.val / 11 * 255).toString(16) + "00";
                link.style.borderColor = r8_color;
                let img = CE({ elem: 'img', src: item.img });
                link.appendChild(img);
                self.container.appendChild(link);
            });
        }
    };

    function drawChartElements(ctx, W, H, category) {
        const PADDING_LEFT = 100, PADDING_BOTTOM = 60, PADDING_TOP = 40, PADDING_RIGHT = 20;
        const chartWidth = W - PADDING_LEFT - PADDING_RIGHT;
        const chartHeight = H - PADDING_TOP - PADDING_BOTTOM;
        const barWidth = chartWidth / 10;
        const FONT_SIZE = 24;
        
        const histogram = new Array(10).fill(0);
        let totalReviews = 0;
        reviews.forEach(review => {
            const rating = GraphManager.getRating(review, category);
            if (rating !== null) {
                const binIndex = Math.min(9, Math.floor(rating));
                histogram[binIndex]++;
                totalReviews++;
            }
        });
        
        if (totalReviews === 0) {
            DistributionManager.noDataMsg.innerText = `No ratings found for '${category}'.`;
            DistributionManager.noDataMsg.style.display = 'block';
            return;
        } else {
            DistributionManager.noDataMsg.style.display = 'none';
        }

        const maxFrequency = Math.max(...histogram);
        ctx.strokeStyle = '#555'; ctx.fillStyle = '#aaa'; ctx.font = `${FONT_SIZE}px sans-serif`; ctx.lineWidth = 2; 

        ctx.beginPath(); ctx.moveTo(PADDING_LEFT, H - PADDING_BOTTOM); ctx.lineTo(W - PADDING_RIGHT, H - PADDING_BOTTOM); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(PADDING_LEFT, H - PADDING_BOTTOM); ctx.lineTo(PADDING_LEFT, PADDING_TOP); ctx.stroke();

        ctx.fillStyle = '#fff';
        ['0', '5', '10'].forEach((label, i) => {
            const x = PADDING_LEFT + (i / 2) * chartWidth;
            ctx.textAlign = (i === 0) ? 'left' : (i === 1) ? 'center' : 'right';
            ctx.fillText(label, x, H - PADDING_BOTTOM + FONT_SIZE);
        });

        ctx.textAlign = 'right'; ctx.fillStyle = '#fff';
        ctx.fillText('0', PADDING_LEFT - 10, H - PADDING_BOTTOM + 5);
        ctx.fillText(maxFrequency, PADDING_LEFT - 10, PADDING_TOP + FONT_SIZE / 2);
        
        ctx.textAlign = 'center'; ctx.save(); ctx.translate(PADDING_LEFT / 2, H / 2); ctx.rotate(-Math.PI / 2); ctx.fillText('Frequency (Count)', 0, 0); ctx.restore();

        histogram.forEach((count, index) => {
            const barHeight = (count / maxFrequency) * chartHeight;
            const x = PADDING_LEFT + index * barWidth;
            const y = H - PADDING_BOTTOM - barHeight;
            const ratingCenter = index + 0.5; 
            const r = Math.floor((1 - ratingCenter / 10) * 255);
            const g = Math.floor((ratingCenter / 10) * 255);
            ctx.fillStyle = `rgb(${r}, ${g}, 0)`;
            ctx.fillRect(x, y, barWidth - 5, barHeight); 
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText(count, x + barWidth / 2, y - 5);
        });
    }

    const DistributionManager = {
        canvas: document.getElementById('review_distribution_chart'),
        categoryLabel: document.getElementById('distribution-category'),
        noDataMsg: document.getElementById('review_distribution_container').querySelector('.no-data-msg'),
        draw: (sortMethod = 'overall-desc') => {
            const self = DistributionManager;
            const [category] = sortMethod.split('-');
            self.categoryLabel.innerText = category.charAt(0).toUpperCase() + category.slice(1); 
            const ctx = self.canvas.getContext('2d');
            const W = self.canvas.width;
            const H = self.canvas.height;
            ctx.clearRect(0, 0, W, H);
            const watermarkImg = new Image();
            watermarkImg.src = '/assets/icon.svg'; 
            const drawContent = () => {
                const watermarkSize = Math.min(W, H) * 0.7; 
                const watermarkX = (W - watermarkSize) / 2; 
                const watermarkY = (H - watermarkSize) / 2; 
                const iconSize = watermarkSize * 0.5; 
                const iconX = watermarkX + (watermarkSize - iconSize) / 2;
                const iconY = watermarkY + (watermarkSize - iconSize) / 2;
                ctx.globalAlpha = 0.1;
                ctx.drawImage(watermarkImg, iconX, iconY, iconSize, iconSize);
                ctx.globalAlpha = 1.0;
                drawChartElements(ctx, W, H, category);
            };
            if (watermarkImg.complete) { drawContent(); } 
            else { watermarkImg.onload = drawContent; watermarkImg.onerror = () => { drawChartElements(ctx, W, H, category); }; }
        }
    };

    const select = document.getElementById("sortingOption");
    const sortKeys = new Set(['overall']); 
    reviews.forEach(r => Object.keys(r.rankings).forEach(k => sortKeys.add(k)));
    select.innerHTML = ''; 
    
    // --- ADDED: Date Sorting Options ---
    const dateNew = document.createElement('option');
    dateNew.value = 'date-desc';
    dateNew.innerText = 'Date (New to Old)';
    select.appendChild(dateNew);

    const dateOld = document.createElement('option');
    dateOld.value = 'date-asc';
    dateOld.innerText = 'Date (Old to New)';
    select.appendChild(dateOld);
    // -----------------------------------

    sortKeys.forEach(key => {
        const optH = document.createElement('option'); optH.value = `${key}-desc`; optH.innerText = `${key} (High to Low)`; select.appendChild(optH);
        const optL = document.createElement('option'); optL.value = `${key}-asc`; optL.innerText = `${key} (Low to High)`; select.appendChild(optL);
    });

    /* --- TABLE GENERATION --- */
    
    function renderTable(sortMethod) {
        let table = document.getElementById("review_table").querySelector("tbody");
        while(table.children.length > 0) { // Clear body
            table.removeChild(table.lastChild);
        }

        let [key, dir] = sortMethod.split('-');
        let sortedReviews = [...reviews].map((r, i) => ({...r, originalIndex: i}));
        
        sortedReviews.sort((a, b) => {
            // --- MODIFIED: Date Sorting Logic ---
            if (key === 'date') {
                const dateA = new Date(a.date || 0).getTime();
                const dateB = new Date(b.date || 0).getTime();
                return dir === 'asc' ? dateA - dateB : dateB - dateA;
            }
            // ------------------------------------
            let valA = GraphManager.getRating(a, key) || 0;
            let valB = GraphManager.getRating(b, key) || 0;
            return dir === 'asc' ? valA - valB : valB - valA;
        });

        for (let i = 0; i < sortedReviews.length; ++i) {
            let data = sortedReviews[i];
            let row = CE({ elem: "tr" });

            // --- COLUMN 1: GAME INFO (Replaces nth-child(1)) ---
            let td1 = CE({ 
                elem: "td", 
                title: "Game", 
                class: "col-game"
            });
            td1.setAttribute('data-label', 'Game:');
            
            // This div is the key flex-grow item that consumes vertical space.
            let imgAnchor = CE({elem: 'div', id: `review_ref_${data.originalIndex}`}); 
            
            let img = CE({ 
                elem: "img", 
                src: data.img,
                id: `img_cover_${data.originalIndex}`, 
                class: "game-cover-image" 
            });
            
            imgAnchor.appendChild(img);
            td1.appendChild(imgAnchor);

            if (data.links) {
                let links = CE({ elem: "div", id: "store_links" });
                
                Object.keys(data.links).forEach(storeName => {
                    let a = CE({ elem: "a", href: data.links[storeName] });
                    let iconSrc = icons[storeName] || icons.website;
                    let storeIcon = CE({
                        elem: "img",
                        src: iconSrc,
                        alt: storeName,
                        class: `store-icon icon${storeName}` 
                    });
                    a.appendChild(storeIcon);
                    links.appendChild(a);
                });
                td1.appendChild(links);
            }
            row.appendChild(td1);

            // --- COLUMN 2: RATINGS (Replaces nth-child(2)) ---
            let td2 = CE({ 
                elem: "td", 
                title: "Ratings", 
                class: "col-ratings"
            });
            td2.setAttribute('data-label', 'Ratings:');
            
            let overallVal = GraphManager.getRating(data, 'overall') || 0;
            let n = overallVal; 
            let r8_color = "#" + Math.floor((((n - 11) * -1) / 10) * 255).toString(16) + Math.floor(n / 11 * 255).toString(16) + "00";

            let overallDiv = CE({ elem: "div", innerText: `${overallVal.toFixed(1)}/10`, id: "overall" });
            overallDiv.style.color = r8_color;
            td2.appendChild(overallDiv);

            Object.entries(data.rankings).forEach(([rKey, rVal]) => {
                if(rKey === 'overall') return;
                let container = CE({ elem: "div", innerText: rKey, id: rKey });
                let ratingSpan = CE({ elem: "span", innerText: `${rVal}/10` });
                let subColor = "#" + Math.floor((((rVal - 11) * -1) / 10) * 255).toString(16) + Math.floor(rVal / 11 * 255).toString(16) + "00";
                ratingSpan.style.color = subColor;
                container.appendChild(ratingSpan);
                td2.appendChild(container);
            });
            row.appendChild(td2);

            // --- COLUMN 3: TLDR (Replaces nth-child(3)) ---
            let td3 = CE({ 
                elem: "td", 
                title: "TLDR", 
                class: "col-tldr"
            });
            td3.setAttribute('data-label', 'TLDR:');
            
            let paraHolder = CE({ elem: "div" });
            let p = CE({ elem: "p", innerHTML: data.review });
            paraHolder.appendChild(p);
            td3.appendChild(paraHolder);
            row.appendChild(td3);

            table.appendChild(row);
        }
    }

    /* --- INITIALIZATION --- */
    select.addEventListener('change', (e) => {
        const val = e.target.value;
        if(!val) return;
        
        renderTable(val); 
        
        // --- MODIFIED: Prevent Charts Breaking on Date Sort ---
        // If sorting by date, force the charts to use 'overall' ratings
        // otherwise they try to plot "date" as a score and fail.
        let chartSort = val.startsWith('date') ? 'overall-desc' : val;
        // ----------------------------------------------------

        GraphManager.draw(chartSort); 
        DistributionManager.draw(chartSort);
    });

    // --- MODIFIED: New Default Sort ---
    const defaultSort = 'date-desc'; 
    select.value = defaultSort; 
    
    // Logic to handle initial chart draw
    renderTable(defaultSort); 
    GraphManager.draw('overall-desc'); // Force overall for initial date sort
    DistributionManager.draw('overall-desc');
    // ----------------------------------

</script>     
        </div>
</body>
</html>
